\chapter{Android Aufnahmesystem}

Folgendes Kapitel behandelt das auf Google Android basierende Aufnahmesystem. Das Aufnahmesystem besteht aus zwei separaten Android Applikationen mit der Bezeichnung \textit{TourLive.apk} sowie \textit{TourLiveRecoveryService.apk}. Der Fokus folgender Unterkapitel liegt auf den Spezifikationen und der technischen Umsetzung des Aufnahmesystems und ist für Entwickler gedacht, die das Aufnahmesystem gerne erweitern möchten.

\section{Software Analyse}

\subsection{Anforderungen}

Um die Anforderungen zu evaluieren wurde das bestehende Aufnahmesystem auf Basis von Nokia Symbian analysiert. Alle vorhandenen Funktionen wurden erfasst und gemeinsam mit dem Industriepartner um weitere ergänzt. 
Eine kurze Übersicht über die bereits bestehenden Funktionen und den neu erfassten Anforderungen liegt in tabellarischer Form vor.

{\renewcommand{\arraystretch}{2}%
    \begin{longtable}{  p{3.5cm} | p{4.3cm} | p{4.3cm} }
    
    \textbf{Requirements} & \textbf{Altes System} & \textbf{Neues System} \\ \hline
\hline
    Positionsdaten übertragen & Geschwindigkeit, H\"{o}he, Richtung/Beschleunigung, Steigung, Longitude, Latitude & Geschwindigkeit, H\"{o}he, Richtung, Steigung, Longitude, Latitude \\ \hline
    Etappendaten & Zeit, Höhe, Distanz, Durchschnittliche Geschwindigkeit, UTC Zeit, Datum & Zeit, Höhe, Distanz, Durchschnittliche Geschwindigkeit \\
    \hline
     Tour Total & Zeit Total, Zeit Tour, Distanz Total, Distanz Tour, Höhe Total, H\"{o}he Tour & - \\
    \hline
    Netzdaten übertragen & Zellen ID, Location Area, Signal, Akku, Netzwerk, Netzwerk ID & Zellen ID, Area, Signal, Netzwerk ID, Technologie, Datenrate, RTT, Packet Loss\\
    \hline
    Bilder \"{u}bertragen & Bilder wurden \"{u}bertragen & Bilder werden \"{u}bertragen\\
    \hline
    Videostream \"{u}bertragen & Einzelne Bilder wurden \"{u}bertragen und serverseitig zu einem Stream zusammengef\"{u}gt & Videosequenzen werden \"{u}bertragen und serverseitig zu einem Stream zusammengesetzt\\
    \hline
    Lokales Caching & nur Bilder wurden gecacht & S\"{a}mtliche aufgenommene Daten werden lokal gespeichert\\
    \hline
	Aufnahme- systemstatus \"{u}bertragen & nur der Akkustand wurde an das Device Management Portal \"{u}bertragen & Detaillierte Statusinformation an das Device Management Portal\\
    \hline    
    Betriebsmodi & - & Managed - Einstellungen \"{u}ber das Portal / Unmanaged - Einstellungen am Ger\"{a}t\\
    \hline
	Auto-Start der App & - & App wird beim Ger\"{a}testart automatisch gestartet\\
    \hline    
    Externe Ger\"{a}te & ODB (Onboard Diagnose Bus) und Pulsinfo Ger\"{a}te wurden angesteuert & -\\
    \hline  
    Smartphone tauglich & Symbian App & Android App\\
    \hline 
    Log & Position und Bilder gesendet & Daten, Bilder, Status und Einstellungen gesendet / Exceptions\\
    \hline 
    Aufnahmestart Modi & Aufnahme hat automatisch bei App Start gestartet & Manuell, Zeitbasiert, Fernverwaltet oder bei Aktivierung einer externen Stromquelle\\
    \hline 
   	Power Management & - & Bei niedrigem Akkustand wird ein Energiesparmodus aktiviert\\
    \hline 
    Alarming Funktion & - & Treten Probleme auf, so wird darauf hingewiesen (z.B. keine GPS Daten w\"{a}hrend 2 Minuten)\\
    \hline 
    Mehrsprachig- keit & - & Deutsch und Englisch, einfach erweiterbar\\
    \hline 
    Fehlerkorrektur der GPS Daten & - & Ausreisser bei den GPS Daten werden herausgefiltert\\
    
    
\caption{Anforderungen Android Aufnahme System}
\end{longtable}}

Eine detaillierte Beschreibung aller Anforderungen befindet sich im Anhang im Kapitel \ref{sec:anforderungenandroiddevmgmt}. Folgend werden die aus unserer Sicht wichtigsten Anforderungen beschrieben.

\subsubsection{Funktionale Anforderungen}
\paragraph{Positionsaufnahme}
Die primäre Funktion des Aufnahmesystems besteht in der Aufnahme von Geopositionsdaten, deren Weiterverarbeitung und der Übermittlung an den TourLive Server. Über das GPS-Modul des Mobilfunkgerätes werden folgende Daten ermittelt:
\begin{itemize}
\item Aktuelle Position [GPS Longitude / Latitude]
\item Aktuelle H\"{o}he (GPS H\"{o}he) [m]
\item Aktuelle Zeit (GPS Timestamp) [unix\_time]
\item Geschwindigkeit (wird gelesen) [km/h]
\item Richtung (in Azimut, wird berechnet) [°]
\item Steigung (\"{u}ber die letzten 100m, wird berechnet) [%]
\item Anzahl Satelliten mit denen das Aufnahmeger\"{a}t verbunden ist
\end{itemize}

\paragraph{Bildaufnahme}
Ein wesentlicher Bestandteil des Aufnahmesystems ist die \"{U}bertragung von Bildmaterial in Form von einzelnen Bildern oder einem Videostream bestehend aus Videosequenzen. Folgende Funktionalit\"{a}t muss dabei beachtet werden:
\begin{itemize}
\item Anpassung der Bildaufl\"{o}sung adaptiv an die verf\"{u}gbare Datenraten (optional)
\item Bilder sollen automatisch, in der korrekten Ausrichtung an den Server geschickt werden (Stichwort Ger\"{a}tesensoren)
\end{itemize}


\subsubsection{Nichtfunktionale Anforderungen}

\paragraph{Sicherheit}
In Bezug auf Vertraulichkeit und Integrit\"{a}t werden keine speziellen Anforderungen gestellt. Die Daten\"{u}bertragung erfolgt unverschl\"{u}sselt. Das Aufnahmeger\"{a}t muss sich am TourLive Server nicht explizit authentisieren. In Bezug auf Verf\"{u}gbarkeit sind die Anforderungen hoch. W\"{a}hrend dem Rennen soll es keine L\"{u}cken ohne Daten von mehr als 5 Minuten geben. K\"{o}nnen w\"{a}hrend einer bestimmten Zeitspanne keine Daten \"{u}bertragen werden, sollen diese gepuffert und zu einem sp\"{a}teren Zeitpunkt \"{u}bertragen werden. 

\paragraph{Ausfallsicherheit}
Die gesammelten Daten (Positionen, Bilder,..) werden parallel auf dem lokalen Ger\"{a}tespeicher abgelegt. Erreicht dieser 80\% der verf\"{u}gbaren Kapazit\"{a}t werden automatisch alte Eventdaten gel\"{o}scht. Über dieses lokale Caching wird sichergestellt, dass die  gesammelten Daten aufgrund technischer Probleme bei der Daten\"{u}bertragung nicht verloren gehen. 

\subsection{Technologien}

\subsubsection{Android}
Java ist die native Programmiersprache des Android Betriebssystems. Die Programmierung in Java bringt den Vorteil, dass auf die gesamte Application Programming Interface (API) von Android zugegriffen werden kann. Da sämtliche Komponenten des TourLive Projektes in Java geschrieben sind kann teilweise auf Server- wie auch Clientseite auf dieselben Bibliotheken zurückgegriffen werden was mögliche Inkompatibilitäten vermindert. 

\subsubsection{Externe Libraries}
Um den geforderten Funktionsumfang umzusetzen, wird einfachheitshalber auf folgende zwei externe Libraries zurückgegriffen.
\paragraph{Spring for Android\footnote{Spring for Android, \url{http://www.springsource.org/spring-android}, aufgerufen am 29.04.2013} }
Ein Rest Client für Android von den Entwicklern des Java Spring Frameworks. Der Rest Client bietet die einfache Möglichker von Serialisierung/Deserialisierung von Java Objekten in JSON-Strings. 
\paragraph{ORMLite\footnote{ORMLite, \url{ormlite.com}, aufgerufen am 02.05.2013}} ORMLite ist eine OpenSource Java Library, welche das Object-Relational Mapping
(ORM) übernimmt. ORMLite bietet eine speziell auf Android angepasste Distribution.\\
Um eine Klasse mit ihren Feldern zur Persistierung zu markieren, werden Java Annotationen verwendet. Aus diesen Annotationen erstellt ORMLite die Datenbank. Darüber hinaus werden mit ORMLite alle Zugriffe auf die SQLite Datenbank ausgeführt. In dieser Arbeit wird die ORMLite Version 4.45 verwendet. Diese Library wird verwendet um die gesammelten Informationen lokal in einer Datenbank speichern zu können und um somit die Datenkonsistenz bei Verbindungsunterbrüchen sicherstellen zu können.

\subsection{Paper Protoypes}
Nach dem die Anforderungen definiert waren, haben wir Paper Prototypes erstellt. Diese wurden mit dem Industriepartner besprochen. So konnten mögliche Missverständnise eliminiert werden. Hier eine Übersicht über alle erstellten Mockups. Eine genauere Beschreibung befindet sich im Anhang.

\begin{figure}[H]
	\centering
	\includegraphics[width=150mm]{images/android/OverviewAndroid.png}
	\caption{Übersicht Android Mockups}
\end{figure}

\subsection{Domain Model}


\section{Software Design}
\subsection{Architektur und Übersicht}
Die Android Applikation sammelt Daten für die beiden Server. In der Abbildung \ref{fig:grobstrukturandroid}
 wird veranschaulicht, welche Daten an welchen Server verschickt werden.

\begin{figure}[H]
	\centering
	\includegraphics[width=120mm]{images/android/uebersicht.png}
	\caption{Grobstruktur der Android App}
	\label{fig:grobstrukturandroid} 
\end{figure}


\subsubsection{Architekturentscheide}

\paragraph{Caching}
Um sämtliche aufgenommene Daten zu Cachen, haben wir uns für die Objektrelationale Abbildung der Klassen in der SQLite Datenbank entschieden. Dies ermöglicht mit Annotation eine schnelle Einbindung. Alternativen wären die Speicherung in ein Textfile oder die Speicherung in der Datenbank ohne Objektrelationale Abbildung, jedoch stand beides nicht zur Diskussion, da sie einem ORM gegenüber viele Nachteile bringen.

\paragraph{Datenhaltung}
Um die verschiedenen Services und Container überall zur Verfügung zu haben und somit lange Aufrufketten zu verhindern, wurde ein Singleton Repository eingeführt. In diesem Repository können über Methoden auf alle Daten zugegriffen werden, die von diversen Klassen gebraucht werden.

\paragraph{TourLiveApplication}
Beim Start der Applikation müssen viele Daten initialisiert werden. Um dies bereits zu machen, bevor eine View geladen wurde, wurde eine TourLiveApplication erstellt, welche von der Android Klasse Application abgeleitet wird. 

\paragraph{Berechnungen}

\subsection{Schichtenmodell und Paketdiagramm}
Die Android Applikation teilt sich in 3 Schichten auf.

\begin{figure}[H]
	\centering
	\includegraphics[width=150mm]{images/android/schichten.jpg}
	\caption{Packagediagramm des Aufnahmesystems}
\end{figure}

Die oberste Schicht stellt die Schnittstelle zum Benutzer dar. Diese Klassen sind für die Darstellung zuständig.\\
In der nächsten Schicht ist die ganz Businesslogik enthalten. Hier werden bei einer Aufnahme alle Timer gestartet und verwaltet und die jeweiligen Aktionen ausgeführt. \\
In der letzten Schicht enthält die Domäne des Aufnahmesystems.

\section{Realisierung}

\subsection{GUI}
Die \textit{MainActivity} ist die Hauptansicht der Applikation. Sie ist in drei Teile unterteilt, Header, Footer und Hauptbereich. Diese Klasse wird direkt nach der Erstellung der TourLiveApplication erstellt.

\begin{figure}[H]
	\centering
	\includegraphics[width=150mm]{images/android/status.png}
	\caption{Aufnahmesystem MainActivity}
\end{figure}


\subsubsection{Header}
\begin{figure}[H]
	\centering
	\includegraphics[width=150mm]{images/android/header.png}
	\caption{Aufnahmesystem Header}
\end{figure}



\subsubsection{Footer}
\begin{figure}[H]
	\centering
	\includegraphics[width=150mm]{images/android/footer.png}
	\caption{Aufnahmesystem Footer}
\end{figure}

\subsubsection{Hauptbereich}

\subsection{Berechtigungen}
