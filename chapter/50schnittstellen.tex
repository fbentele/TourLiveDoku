\chapter{Schnittstellen}

Das Aufnahmesystem kommuniziert mit beiden Serversystemen in beide Richtungen. In diesem Kapitel werden die Schnittstellen zwischen Aufnahmesystem,  Tourlive Server sowie Devicemanagement Portal erläutert.
 

\section{TourLive Server Schnittstelle}

{\renewcommand{\arraystretch}{1.1}%
    \begin{longtable}{ p{2.5cm} p{3.5cm} p{7cm}}

	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/api/valuecontainer} \\
	\textbf{Request:} & Method: & POST \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'ValueContainer' \\
	\textbf{Response:} & Header: & HTTP/1.1 200 OK \\
		& Body: & <empty> \\
	\textbf{Zeitpunkt:} & \multicolumn{2}{p{10cm}}{Bei laufender Aufnahme} \\ 
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{einstellbar} \\
\hline
\hline
	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/api/image} \\
	\textbf{Request:} & Method: & POST \\
		& Content-Type: & multipart/form-data [3 Boundaries] \\
		& Body-Boundary 1: & text/plain (timestamp) \\
		& Body-Boundary 2: & text/plain (deviceId) \\
		& Body-Boundary 3: & application/octet-stream (Bild) \\
	\textbf{Response:} & Header: & HTTP/1.1 200 OK \\
		& Body: & <empty> \\
	\textbf{Zeitpunkt:} & \multicolumn{2}{p{10cm}}{Bei laufender Aufnahme, falls Image aktiviert ist} \\ 
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{einstellbar} \\
\hline
\hline
	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/api/video} \\
	\textbf{Request:} & Method: & POST \\
		& Content-Type: & multipart/form-data [3 Boundaries] \\
		& Body-Boundary 1: & text/plain (timestamp) \\
		& Body-Boundary 2: & text/plain (deviceId) \\
		& Body-Boundary 3: & application/octet-stream (Video) \\
	\textbf{Response:} & Header: & HTTP/1.1 200 OK \\
		& Body: & <empty> \\
	\textbf{Zeitpunkt:} & \multicolumn{2}{p{10cm}}{Bei laufender Aufnahme, falls der Videostream aktiviert ist} \\ 
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{einstellbar} \\
\hline
\hline
	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/api/racedata} \\
	\textbf{Request:} & Method: & GET \\
		& Body: & empty\\	
	\textbf{Response:} & Method: & GET \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'RaceData' \\	
	
	\textbf{Zeitpunkt:} & \multicolumn{2}{p{10cm}}{immer} \\ 
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{60 Sekunden} \\
\hline
\hline 
\caption{Schnittstellen TourLiveServer Übersicht}
\end{longtable} }
TODO FLO

\section{Device Management Portal Schnittstelle}


{\renewcommand{\arraystretch}{1.1}%
    \begin{longtable}{ p{2.5cm} p{3.5cm} p{7cm}}
	\textbf{URL:} & \multicolumn{2}{l}{/devmgmtsrv/api/postdevicemanagementcontainer} \\
	\textbf{Request:} & Method: & POST \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'DeviceManagementContainer'\\
	\textbf{Response:} &  Header: & HTTP/1.1 200 OK \\
		& Body: & <empty>	\\
	\textbf{Eigenschaft:} & \multicolumn{2}{p{10cm}}{Wird einmalig beim App Start ausgeführt sowie bei lokalen Änderungen in den Einstellungen} \\
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{unregelmässig} \\
\hline
\hline    
	\textbf{URL:} & \multicolumn{2}{l}{/devmgmtsrv/api/getdevicemanagementcontainer} \\
	\textbf{Request:} & Content-Type: & application/json \\
		& Method: & POST \\
		& Body: & JSON-String 'StatusData' \\
	\textbf{Response:} & Method: & POST \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'DeviceManagementContainer' \\
	\textbf{Eigenschaft:} & \multicolumn{2}{p{10cm}}{Wird regelmässig als Service ausgeführt.} \\ 
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{regelmässig - alle 60 Sekunden} \\
\hline
\hline    
	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/devmgmtsrv/api/postlog} \\
	\textbf{Request:} & Method: & POST \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'TourLiveLog' \\
	\textbf{Response:} &  Header: & HTTP/1.1 200 OK \\
		& Body: & <empty>	\\
	\textbf{Eigenschaft:} &  \multicolumn{2}{p{10cm}}{Wird regelmässig als Service ausgeführt.}\\ 
	\textbf{Interval:} &  \multicolumn{2}{p{10cm}}{regelmässig - alle 60 Sekunden}\\
\hline
\hline 
	\textbf{URL:} & \multicolumn{2}{p{10cm}}{/devmgmtsrv/api/getMsg/\{deviceId\}} \\
	\textbf{Request:} & Method: & GET \\
		& Body: & <empty> \\
	\textbf{Response:} & Method: & POST \\
		& Content-Type: & application/json \\
		& Body: & JSON-String 'Message' \\
	\textbf{Eigenschaft:} & \multicolumn{2}{p{10cm}}{ Wenn das 'messageAvailable'-Flag gesetzt ist in einem empfangenen DeviceManagementContainer.} \\
	\textbf{Interval:} & \multicolumn{2}{p{10cm}}{unregelmässig}\\
\hline
\hline 

\caption{Schnittstellen DeviceManagement Portal Übersicht}
\end{longtable} }

\pagebreak
\subsection{Status posten und Einstellungen erhalten}

Um den aktuellen Status des Aufnahmesystems dem Server mitzuteilen kann diese Methode aufgerufen werden. Als Antwort erhält man die im Moment aktuellen Einstellungen.

{\bf URL: }http://tlng.cnlab.ch/devmgmtsrv/api/getdevicemanagementcontainer 

\subsubsection{Status JSON}

Das JSON eines Status Posts sieht folgendermassen aus:

\begin{figure}[H]
	\centering
	\lstinputlisting[language=json]{jsonfiles/status.json}
	\caption{Status JSON}
\end{figure}


\pagebreak
\subsubsection{Einstellungen JSON}

Die Antwort die man bei dieser Anfrage erhält ist die folgende:

\begin{figure}[H]
	\centering
	\lstinputlisting[language=json]{jsonfiles/settings.json}
	\caption{Einstellungen JSON}
\end{figure}


\subsection{Log posten}

Um neue Logeinträge dem Server zu übermitteln kann diese Methode benutzt werden.

{\bf URL: }http://tlng.cnlab.ch/devmgmtsrv/api/postlog

\subsubsection{Log JSON}

Das JSON eines Log Posts sieht folgendermassen aus:

\begin{figure}[H]
	\centering
	\lstinputlisting[language=json]{jsonfiles/log.json}
	\caption{Log JSON}
\end{figure}

\subsection{Nachricht abholen}

Sofern eine neue Nachricht für das Gerät vorhanden ist kann sie über diese Methoden abgeholt werden.

{\bf URL: }http://tlng.cnlab.ch/devmgmtsrv/api/getmsg/{deviceId}

\subsubsection{Nachrichten JSON}
Das JSON für die Nachrichten ist das folgende:
\begin{figure}[H]
	\centering
	\lstinputlisting[language=json]{jsonfiles/message.json}
	\caption{Nachrichten JSON}
\end{figure}


